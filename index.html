<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Video Player - Debug Version</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- A-Frame ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <!-- AR.js ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body style='margin: 0; overflow: hidden; font-family: Arial, sans-serif;'>
    
    <!-- ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ  -->
    <a-scene embedded arjs='debugUIEnabled: true; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'>
        <a-assets>
            <!-- å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
            <video id="video1" src="./assets/videos/sample-3.mp4" preload="auto" crossorigin="anonymous" webkit-playsinline playsinline muted loop></video>
        </a-assets>
        
        <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨ -->
        <a-marker type="pattern" url="./pattern-sample-p.patt" id="custom-marker">
            <!-- ãƒ†ã‚¹ãƒˆç”¨ã®ç°¡å˜ãª3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
            <a-box position="0 0.5 0" color="red" scale="0.5 0.5 0.5" 
                   animation="property: rotation; to: 0 360 0; loop: true; dur: 2000">
            </a-box>
            
            <!-- å‹•ç”»ã‚’è¡¨ç¤ºã™ã‚‹å¹³é¢ -->
            <a-plane 
                position="0 0 0" 
                rotation="-90 0 0" 
                width="2" 
                height="1.5" 
                material="src: #video1; transparent: true; alphaTest: 0.1;">
            </a-plane>
            
            <!-- ã‚¿ã‚¤ãƒˆãƒ«ãƒ†ã‚­ã‚¹ãƒˆ -->
            <a-text 
                value="ğŸ¬ MARKER DETECTED!" 
                position="0 1.2 0" 
                align="center" 
                color="#00ff00"
                scale="1.5 1.5 1.5">
            </a-text>
        </a-marker>
        
        <!-- ã‚«ãƒ¡ãƒ©ã‚’è¿½åŠ  -->
        <a-entity camera></a-entity>
    </a-scene>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div id="debug-panel" style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.9); color: white; padding: 20px; border-radius: 12px; max-width: 350px; z-index: 1000; font-size: 12px;">
        <h3 style="margin: 0 0 15px 0; color: #00ff00;">ğŸ”§ AR Debug Console</h3>
        
        <!-- AR.js çŠ¶æ…‹ -->
        <div style="margin: 10px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px;">
            <strong>ğŸ“¡ AR.js Status:</strong>
            <div id="arjs-status" style="color: #ffeb3b;">åˆæœŸåŒ–ä¸­...</div>
        </div>
        
        <!-- ãƒãƒ¼ã‚«ãƒ¼çŠ¶æ…‹ -->
        <div style="margin: 10px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px;">
            <strong>ğŸ¯ Marker Status:</strong>
            <div id="marker-status" style="color: #ff9800;">æ¤œç´¢ä¸­...</div>
            <div>æ¤œå‡ºå›æ•°: <span id="detection-count" style="color: #4caf50;">0</span></div>
            <div>æ¶ˆå¤±å›æ•°: <span id="lost-count" style="color: #f44336;">0</span></div>
        </div>
        
        <!-- å‹•ç”»çŠ¶æ…‹ -->
        <div style="margin: 10px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px;">
            <strong>ğŸ¬ Video Status:</strong>
            <div id="video-status" style="color: #2196f3;">èª­ã¿è¾¼ã¿ä¸­...</div>
            <div id="video-info"></div>
        </div>
        
        <!-- ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ…‹ -->
        <div style="margin: 10px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px;">
            <strong>ğŸ“ File Status:</strong>
            <div id="file-status">
                <div>âœ… pattern-sample-p.patt: <span id="patt-status">ç¢ºèªä¸­...</span></div>
                <div>ğŸ¬ sample-3.mp4: <span id="video-file-status">ç¢ºèªä¸­...</span></div>
            </div>
        </div>
        
        <!-- ã‚«ãƒ¡ãƒ©çŠ¶æ…‹ -->
        <div style="margin: 10px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px;">
            <strong>ğŸ“· Camera Status:</strong>
            <div id="camera-status" style="color: #9c27b0;">ç¢ºèªä¸­...</div>
        </div>
        
        <!-- æ‰‹å‹•ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ -->
        <div style="margin: 15px 0;">
            <button id="test-video" style="padding: 8px 12px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 11px; margin: 2px;">å‹•ç”»ãƒ†ã‚¹ãƒˆ</button>
            <button id="force-show" style="padding: 8px 12px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 11px; margin: 2px;">3Dè¡¨ç¤ºãƒ†ã‚¹ãƒˆ</button>
        </div>
    </div>

    <script>
        let detectionCount = 0;
        let lostCount = 0;
        let currentVideo = null;
        let isMarkerVisible = false;

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°é–¢æ•°
        function updateStatus(elementId, message, color = 'white') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.color = color;
            }
            console.log(`[${elementId}] ${message}`);
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
        async function checkFiles() {
            // .pattãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            try {
                const response = await fetch('./pattern-sample-p.patt');
                if (response.ok) {
                    updateStatus('patt-status', 'âœ… è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ', '#4caf50');
                } else {
                    updateStatus('patt-status', 'âŒ 404ã‚¨ãƒ©ãƒ¼', '#f44336');
                }
            } catch (error) {
                updateStatus('patt-status', 'âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', '#f44336');
            }

            // å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            const video = document.querySelector('#video1');
            if (video) {
                video.addEventListener('loadeddata', function() {
                    updateStatus('video-file-status', 'âœ… èª­ã¿è¾¼ã¿å®Œäº†', '#4caf50');
                    updateStatus('video-info', `${video.duration.toFixed(1)}ç§’, ${video.videoWidth}x${video.videoHeight}`, '#4caf50');
                });
                
                video.addEventListener('error', function() {
                    updateStatus('video-file-status', 'âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', '#f44336');
                });
            }
        }

        // AR.jsåˆæœŸåŒ–ç¢ºèª
        function checkARJS() {
            updateStatus('arjs-status', 'åˆæœŸåŒ–å®Œäº† âœ…', '#4caf50');
            
            // ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
            navigator.mediaDevices.getUserMedia({video: true})
                .then(function(stream) {
                    updateStatus('camera-status', 'âœ… ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯', '#4caf50');
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(function(error) {
                    updateStatus('camera-status', 'âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦', '#f44336');
                });
        }

        // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        AFRAME.registerComponent('debug-marker', {
            init: function () {
                const el = this.el;
                console.log('Debug marker component initialized');
                
                // ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸæ™‚
                el.addEventListener('markerFound', function() {
                    detectionCount++;
                    isMarkerVisible = true;
                    updateStatus('marker-status', 'ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºä¸­!', '#4caf50');
                    document.getElementById('detection-count').textContent = detectionCount;
                    
                    console.log('ğŸ¯ MARKER FOUND! Count:', detectionCount);
                    
                    // å‹•ç”»å†ç”Ÿ
                    if (currentVideo) {
                        currentVideo.play().then(() => {
                            updateStatus('video-status', 'â–¶ï¸ å†ç”Ÿä¸­', '#4caf50');
                        }).catch(error => {
                            updateStatus('video-status', 'âŒ å†ç”Ÿå¤±æ•—: ' + error.message, '#f44336');
                        });
                    }
                });

                // ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹å¤±ã‚ã‚ŒãŸæ™‚
                el.addEventListener('markerLost', function() {
                    lostCount++;
                    isMarkerVisible = false;
                    updateStatus('marker-status', 'âŒ ãƒãƒ¼ã‚«ãƒ¼æ¶ˆå¤±', '#f44336');
                    document.getElementById('lost-count').textContent = lostCount;
                    
                    console.log('âŒ MARKER LOST! Count:', lostCount);
                    
                    // å‹•ç”»ä¸€æ™‚åœæ­¢
                    if (currentVideo) {
                        currentVideo.pause();
                        updateStatus('video-status', 'â¸ï¸ ä¸€æ™‚åœæ­¢', '#ff9800');
                    }
                });
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ AR Video Player Debug Version èµ·å‹•');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
            checkFiles();
            
            // AR.jsç¢ºèªï¼ˆå°‘ã—é…å»¶ï¼‰
            setTimeout(checkARJS, 1000);
            
            // ãƒãƒ¼ã‚«ãƒ¼ã«ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ 
            setTimeout(function() {
                const marker = document.querySelector('#custom-marker');
                if (marker) {
                    marker.setAttribute('debug-marker', '');
                    console.log('âœ… Debug component added to marker');
                } else {
                    console.error('âŒ Marker element not found');
                }
            }, 2000);

            // å‹•ç”»è¦ç´ ã®å–å¾—
            currentVideo = document.querySelector('#video1');
            if (currentVideo) {
                currentVideo.addEventListener('loadstart', () => {
                    updateStatus('video-status', 'ğŸ“¥ èª­ã¿è¾¼ã¿é–‹å§‹', '#2196f3');
                });
                
                currentVideo.addEventListener('canplay', () => {
                    updateStatus('video-status', 'âœ… å†ç”Ÿæº–å‚™å®Œäº†', '#4caf50');
                });
            }

            // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®è¨­å®š
            document.getElementById('test-video').addEventListener('click', function() {
                if (currentVideo) {
                    currentVideo.play().then(() => {
                        updateStatus('video-status', 'â–¶ï¸ æ‰‹å‹•å†ç”Ÿä¸­', '#4caf50');
                    }).catch(error => {
                        updateStatus('video-status', 'âŒ æ‰‹å‹•å†ç”Ÿå¤±æ•—', '#f44336');
                    });
                }
            });

            document.getElementById('force-show').addEventListener('click', function() {
                const marker = document.querySelector('#custom-marker');
                if (marker) {
                    // ãƒãƒ¼ã‚«ãƒ¼ã‚’å¼·åˆ¶è¡¨ç¤º
                    marker.object3D.visible = true;
                    updateStatus('marker-status', 'ğŸ”§ å¼·åˆ¶è¡¨ç¤ºä¸­', '#ffeb3b');
                }
            });
        });

        // 5ç§’ã”ã¨ã®çŠ¶æ…‹ç¢ºèª
        setInterval(function() {
            const scene = document.querySelector('a-scene');
            if (scene && scene.systems && scene.systems.arjs) {
                console.log('ğŸ“Š AR.js System Status:', scene.systems.arjs);
            }
        }, 5000);
    </script>
</body>
</html>