<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Video Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- A-Frame ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <!-- AR.js ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body style='margin: 0; overflow: hidden; font-family: Arial, sans-serif;'>
    
    <!-- ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ  -->
    <a-scene embedded arjs>
        <a-assets>
            <!-- å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
            <video id="video1" src="./assets/videos/sample-3.mp4" preload="auto" crossorigin="anonymous" webkit-playsinline playsinline muted loop></video>
        </a-assets>
        
        <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨ -->
        <a-marker type="pattern" url="./pattern-sample-p.patt" id="custom-marker">
            <!-- å‹•ç”»ã‚’è¡¨ç¤ºã™ã‚‹å¹³é¢ -->
            <a-plane 
                position="0 0 0" 
                rotation="-90 0 0" 
                width="2" 
                height="1.5" 
                material="src: #video1; transparent: true; alphaTest: 0.1;">
            </a-plane>
            
            <!-- ã‚¿ã‚¤ãƒˆãƒ«ãƒ†ã‚­ã‚¹ãƒˆ -->
            <a-text 
                value="ğŸ¬ AR Video Player" 
                position="0 1.2 0" 
                align="center" 
                color="#ff6b6b"
                scale="1.2 1.2 1.2">
            </a-text>
            
            <!-- è£…é£¾çš„ãªè¦ç´  -->
            <a-box 
                position="-1.5 0.2 -0.5" 
                color="#4ecdc4" 
                scale="0.2 0.2 0.2"
                animation="property: rotation; to: 360 360 0; loop: true; dur: 3000">
            </a-box>
            <a-box 
                position="1.5 0.2 -0.5" 
                color="#ff9f43" 
                scale="0.2 0.2 0.2"
                animation="property: rotation; to: -360 -360 0; loop: true; dur: 3000">
            </a-box>
        </a-marker>
        
        <!-- ã‚«ãƒ¡ãƒ©ã‚’è¿½åŠ  -->
        <a-entity camera></a-entity>
    </a-scene>

    <!-- UI ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div id="control-panel" style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.85); color: white; padding: 20px; border-radius: 12px; max-width: 300px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
        <h3 style="margin: 0 0 12px 0; color: #ff6b6b;">ğŸ¬ AR Video Player</h3>
        <p style="margin: 5px 0; font-size: 13px; line-height: 1.4;">ğŸ“± ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã—ã¦ãã ã•ã„</p>
        <div id="status" style="margin: 10px 0; font-size: 12px; color: #4ecdc4; font-weight: bold;">ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...</div>
        
        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
        <div style="margin: 15px 0;">
            <button id="play-btn" style="padding: 8px 12px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 11px; margin-right: 8px;">â–¶ å†ç”Ÿ</button>
            <button id="pause-btn" style="padding: 8px 12px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 11px; margin-right: 8px;">â¸ ä¸€æ™‚åœæ­¢</button>
            <button id="stop-btn" style="padding: 8px 12px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 11px;">â¹ åœæ­¢</button>
        </div>
        
        <!-- éŸ³é‡èª¿æ•´ -->
        <div style="margin: 10px 0;">
            <label style="font-size: 11px;">ğŸ”Š éŸ³é‡: </label>
            <input id="volume-slider" type="range" min="0" max="1" step="0.1" value="0.7" style="width: 100px;">
            <span id="volume-display" style="font-size: 11px;">70%</span>
        </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ -->
    <div id="error-panel" style="position: absolute; bottom: 20px; left: 20px; background: rgba(244, 67, 54, 0.9); color: white; padding: 15px; border-radius: 8px; max-width: 280px; z-index: 1000; display: none;">
        <h4 style="margin: 0 0 8px 0;">âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
        <p id="error-message" style="margin: 0; font-size: 12px;"></p>
    </div>

    <script>
        let currentVideo = null;
        let isPlaying = false;
        let isMarkerVisible = false;

        // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã§å‹•ç”»å†ç”Ÿã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ
        AFRAME.registerComponent('video-on-marker', {
            init: function () {
                const el = this.el;
                const statusElement = document.getElementById('status');
                
                // ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸæ™‚
                el.addEventListener('markerFound', function() {
                    console.log('ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºï¼');
                    isMarkerVisible = true;
                    statusElement.textContent = 'ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºï¼å‹•ç”»ã‚’æº–å‚™ä¸­...';
                    statusElement.style.color = '#4caf50';
                    
                    // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ã‹ã‚‰å‹•ç”»å†ç”Ÿ
                    setTimeout(function() {
                        playVideo();
                    }, 800);
                });

                // ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹å¤±ã‚ã‚ŒãŸæ™‚
                el.addEventListener('markerLost', function() {
                    console.log('ãƒãƒ¼ã‚«ãƒ¼ã‚’è¦‹å¤±ã„ã¾ã—ãŸ');
                    isMarkerVisible = false;
                    statusElement.textContent = 'ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...';
                    statusElement.style.color = '#ff9800';
                    
                    // 2ç§’å¾Œã«ã¾ã ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ãˆãªã‘ã‚Œã°åœæ­¢
                    setTimeout(function() {
                        if (!isMarkerVisible) {
                            pauseVideo();
                        }
                    }, 2000);
                });
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AR Video Player åˆæœŸåŒ–ä¸­...');
            
            // ãƒãƒ¼ã‚«ãƒ¼ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ 
            const marker = document.querySelector('#custom-marker');
            if (marker) {
                marker.setAttribute('video-on-marker', '');
            }

            // å‹•ç”»è¦ç´ ã®å–å¾—
            currentVideo = document.querySelector('#video1');
            
            if (currentVideo) {
                // å‹•ç”»ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                currentVideo.addEventListener('loadeddata', function() {
                    console.log('å‹•ç”»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
                    document.getElementById('status').textContent = 'ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...';
                });

                currentVideo.addEventListener('error', function() {
                    console.error('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼');
                    showError('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ« (sample-3.mp4) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                });

                currentVideo.addEventListener('ended', function() {
                    console.log('å‹•ç”»å†ç”Ÿçµ‚äº†');
                    isPlaying = false;
                    if (isMarkerVisible) {
                        // ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
                        currentVideo.currentTime = 0;
                        currentVideo.play();
                    }
                });

                // åˆæœŸè¨­å®š
                currentVideo.muted = true; // è‡ªå‹•å†ç”Ÿã®ãŸã‚ã«æœ€åˆã¯ãƒŸãƒ¥ãƒ¼ãƒˆ
                currentVideo.volume = 0.7;
            }

            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            setupControlButtons();
        });

        // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¨­å®š
        function setupControlButtons() {
            // å†ç”Ÿãƒœã‚¿ãƒ³
            document.getElementById('play-btn').addEventListener('click', function() {
                playVideo(true); // æ‰‹å‹•å†ç”Ÿ
            });

            // ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³
            document.getElementById('pause-btn').addEventListener('click', function() {
                pauseVideo();
            });

            // åœæ­¢ãƒœã‚¿ãƒ³
            document.getElementById('stop-btn').addEventListener('click', function() {
                stopVideo();
            });

            // éŸ³é‡èª¿æ•´
            const volumeSlider = document.getElementById('volume-slider');
            const volumeDisplay = document.getElementById('volume-display');
            
            volumeSlider.addEventListener('input', function() {
                const volume = parseFloat(this.value);
                if (currentVideo) {
                    currentVideo.volume = volume;
                    currentVideo.muted = (volume === 0);
                }
                volumeDisplay.textContent = Math.round(volume * 100) + '%';
            });
        }

        // å‹•ç”»å†ç”Ÿé–¢æ•°
        function playVideo(isManual = false) {
            if (!currentVideo) {
                showError('å‹•ç”»è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            if (isManual) {
                currentVideo.muted = false; // æ‰‹å‹•å†ç”Ÿæ™‚ã¯ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤
            }

            currentVideo.currentTime = 0;
            
            currentVideo.play().then(function() {
                isPlaying = true;
                console.log('å‹•ç”»å†ç”Ÿé–‹å§‹');
                document.getElementById('status').textContent = 'ğŸ¬ å‹•ç”»å†ç”Ÿä¸­';
                document.getElementById('status').style.color = '#4caf50';
            }).catch(function(error) {
                console.log('è‡ªå‹•å†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸ:', error);
                if (!isManual) {
                    showManualPlayButton();
                }
            });
        }

        // å‹•ç”»ä¸€æ™‚åœæ­¢é–¢æ•°
        function pauseVideo() {
            if (currentVideo && isPlaying) {
                currentVideo.pause();
                isPlaying = false;
                console.log('å‹•ç”»ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ');
                
                document.getElementById('status').textContent = 'â¸ å‹•ç”»ä¸€æ™‚åœæ­¢ä¸­';
                document.getElementById('status').style.color = '#ff9800';
            }
        }

        // å‹•ç”»åœæ­¢é–¢æ•°
        function stopVideo() {
            if (currentVideo) {
                currentVideo.pause();
                currentVideo.currentTime = 0;
                isPlaying = false;
                console.log('å‹•ç”»ã‚’åœæ­¢ã—ã¾ã—ãŸ');
                
                document.getElementById('status').textContent = 'â¹ æ‰‹å‹•åœæ­¢';
                document.getElementById('status').style.color = '#f44336';
            }
        }

        // æ‰‹å‹•å†ç”Ÿãƒœã‚¿ãƒ³è¡¨ç¤ºï¼ˆè‡ªå‹•å†ç”Ÿå¤±æ•—æ™‚ï¼‰
        function showManualPlayButton() {
            const playBtn = document.createElement('div');
            playBtn.innerHTML = `
                <div style="text-align: center;">
                    <h3 style="margin: 0 0 15px 0; color: #ff6b6b;">ğŸ¬ å‹•ç”»ã‚’å†ç”Ÿ</h3>
                    <p style="margin: 0 0 15px 0; font-size: 14px; line-height: 1.4;">ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã§è‡ªå‹•å†ç”Ÿã§ãã¾ã›ã‚“<br>æ‰‹å‹•ã§å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
                    <button id="manual-play-btn" style="padding: 15px 25px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">â–¶ å†ç”Ÿé–‹å§‹</button>
                </div>
            `;
            playBtn.style.cssText = `
                position: fixed; 
                top: 50%; 
                left: 50%; 
                transform: translate(-50%, -50%); 
                z-index: 2000; 
                padding: 30px; 
                background: rgba(0,0,0,0.95); 
                color: white;
                border-radius: 15px; 
                font-family: Arial, sans-serif; 
                max-width: 350px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            document.body.appendChild(playBtn);
            
            document.getElementById('manual-play-btn').addEventListener('click', function() {
                currentVideo.muted = false; // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤
                currentVideo.play().then(function() {
                    isPlaying = true;
                    document.getElementById('status').textContent = 'ğŸ¬ å‹•ç”»å†ç”Ÿä¸­';
                    document.getElementById('status').style.color = '#4caf50';
                    document.body.removeChild(playBtn);
                    console.log('æ‰‹å‹•ã§å‹•ç”»å†ç”Ÿé–‹å§‹');
                }).catch(function(error) {
                    console.error('æ‰‹å‹•å†ç”Ÿã‚‚å¤±æ•—:', error);
                    showError('å‹•ç”»ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
            });

            // 15ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(function() {
                if (document.body.contains(playBtn)) {
                    document.body.removeChild(playBtn);
                }
            }, 15000);
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•°
        function showError(message) {
            const errorPanel = document.getElementById('error-panel');
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.textContent = message;
            errorPanel.style.display = 'block';
            
            // 8ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
            setTimeout(function() {
                errorPanel.style.display = 'none';
            }, 8000);
        }
    </script>
</body>
</html>