<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Fullscreen Video Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        /* å…¨ç”»é¢å‹•ç”»ç”¨ã®CSS */
        .fullscreen-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            object-fit: cover;
            background: #000;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        .loading-spinner {
            border: 4px solid #333;
            border-top: 4px solid #00ffff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .video-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 25px;
            display: none;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #00ffff;
            color: #00ffff;
            padding: 10px 15px;
            margin: 0 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: #00ffff;
            color: #000;
        }
    </style>
</head>
<body style='margin: 0; overflow: hidden; font-family: Arial, sans-serif;'>
    
    <!-- AR.jsã‚·ãƒ¼ãƒ³ -->
    <a-scene 
        embedded 
        arjs='
            trackingMethod: best; 
            sourceType: webcam; 
            debugUIEnabled: false;
            detectionMode: mono_and_matrix; 
            matrixCodeType: 3x3; 
            patternRatio: 0.90;
            maxDetectionRate: 60;
        '
        vr-mode-ui="enabled: false"
        loading-screen="enabled: false">
        
        <a-assets>
            <video 
                id="main-video" 
                src="./assets/videos/sample-3.mp4" 
                preload="auto" 
                crossorigin="anonymous" 
                webkit-playsinline 
                playsinline 
                muted
                loop>
            </video>
        </a-assets>
        
        <!-- ãƒãƒ¼ã‚«ãƒ¼è¨­å®šï¼ˆè¤‡æ•°å¯¾å¿œï¼‰ -->
        <a-marker preset="hiro" id="hiro-trigger" marker-trigger>
            <a-text value="ğŸ¬ Hiro Detected!" position="0 1 0" align="center" color="#00ffff" scale="2 2 2"></a-text>
        </a-marker>
        
        <a-marker type="pattern" url="./pattern-marker.patt" id="custom-trigger" marker-trigger>
            <a-text value="ğŸ¬ Custom Detected!" position="0 1 0" align="center" color="#00ff00" scale="2 2 2"></a-text>
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>

    <!-- èª­ã¿è¾¼ã¿ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <h2 style="margin: 0 0 10px 0; color: #00ffff;">ğŸ¬ å‹•ç”»ã‚’èª­ã¿è¾¼ã¿ä¸­...</h2>
        <p style="margin: 0; opacity: 0.8; font-size: 16px;">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        <div id="loading-progress" style="margin-top: 20px; font-size: 14px; color: #ffeb3b;">
            å‹•ç”»ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ä¸­...
        </div>
    </div>

    <!-- å…¨ç”»é¢å‹•ç”»è¦ç´  -->
    <video 
        id="fullscreen-video" 
        class="fullscreen-video" 
        style="display: none;"
        controls="false"
        webkit-playsinline 
        playsinline>
    </video>

    <!-- å‹•ç”»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div id="video-controls" class="video-controls">
        <button class="control-btn" id="play-pause-btn">â¸ ä¸€æ™‚åœæ­¢</button>
        <button class="control-btn" id="volume-btn">ğŸ”Š éŸ³é‡</button>
        <button class="control-btn" id="fullscreen-btn">ğŸ“º å…¨ç”»é¢</button>
        <button class="control-btn" id="close-btn">âœ• é–‰ã˜ã‚‹</button>
    </div>

    <!-- ARçŠ¶æ…‹è¡¨ç¤ºãƒ‘ãƒãƒ« -->
    <div id="ar-status" style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 10px; max-width: 300px; z-index: 1000; font-size: 13px;">
        <h3 style="margin: 0 0 10px 0; color: #00ffff;">ğŸ¯ AR Video Trigger</h3>
        <div>
            <strong>Status:</strong> <span id="ar-status-text" style="color: #ffeb3b;">ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</span>
        </div>
        <div style="margin-top: 8px; font-size: 11px; color: #aaa;">
            <div>ğŸ¯ Hiro: <span id="hiro-count">0</span> å›æ¤œå‡º</div>
            <div>ğŸ¯ Custom: <span id="custom-count">0</span> å›æ¤œå‡º</div>
        </div>
        <div style="margin-top: 10px; padding: 8px; background: rgba(33, 150, 243, 0.2); border-radius: 5px; font-size: 11px;">
            ğŸ’¡ <strong>ä½¿ã„æ–¹:</strong><br>
            ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã™ã¨å…¨ç”»é¢å‹•ç”»ãŒå†ç”Ÿã•ã‚Œã¾ã™
        </div>
    </div>

    <script>
        let fullscreenVideo = null;
        let originalVideo = null;
        let isVideoPlaying = false;
        let detectionCounts = { hiro: 0, custom: 0 };
        let videoTriggered = false;

        // ãƒãƒ¼ã‚«ãƒ¼ãƒˆãƒªã‚¬ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        AFRAME.registerComponent('marker-trigger', {
            init: function () {
                const el = this.el;
                const markerId = el.id;
                
                el.addEventListener('markerFound', function() {
                    console.log(`ğŸ¯ Marker detected: ${markerId}`);
                    
                    // æ¤œå‡ºå›æ•°æ›´æ–°
                    if (markerId.includes('hiro')) {
                        detectionCounts.hiro++;
                        document.getElementById('hiro-count').textContent = detectionCounts.hiro;
                    } else {
                        detectionCounts.custom++;
                        document.getElementById('custom-count').textContent = detectionCounts.custom;
                    }
                    
                    // ã¾ã å‹•ç”»ãŒèµ·å‹•ã—ã¦ã„ãªã„å ´åˆã®ã¿å®Ÿè¡Œ
                    if (!videoTriggered) {
                        videoTriggered = true;
                        updateARStatus('ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºï¼å‹•ç”»ã‚’æº–å‚™ä¸­...', '#4caf50');
                        triggerVideoPlayback();
                    }
                });
                
                // ãƒãƒ¼ã‚«ãƒ¼æ¶ˆå¤±ã¯å‹•ç”»åœæ­¢ã—ãªã„
                el.addEventListener('markerLost', function() {
                    console.log(`âŒ Marker lost: ${markerId} (å‹•ç”»ã¯ç¶™ç¶š)`);
                });
            }
        });

        // ARçŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
        function updateARStatus(message, color = '#ffeb3b') {
            const statusElement = document.getElementById('ar-status-text');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.color = color;
            }
            console.log(`Status: ${message}`);
        }

        // å‹•ç”»å†ç”Ÿã®ãƒˆãƒªã‚¬ãƒ¼
        function triggerVideoPlayback() {
            console.log('ğŸ¬ Starting video playback sequence...');
            
            // èª­ã¿è¾¼ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
            showLoadingOverlay();
            
            // å‹•ç”»ã®æº–å‚™
            setTimeout(() => {
                prepareVideo();
            }, 1000);
        }

        // èª­ã¿è¾¼ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
        function showLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            
            // èª­ã¿è¾¼ã¿é€²æ—è¡¨ç¤º
            const progressTexts = [
                'å‹•ç”»ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ä¸­...',
                'ãƒ¡ãƒ‡ã‚£ã‚¢è¦ç´ ã‚’åˆæœŸåŒ–ä¸­...',
                'å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã‚’æº–å‚™ä¸­...',
                'å†ç”Ÿé–‹å§‹ã¾ã§ã‚ã¨å°‘ã—...'
            ];
            
            let currentStep = 0;
            const progressInterval = setInterval(() => {
                currentStep++;
                if (currentStep < progressTexts.length) {
                    document.getElementById('loading-progress').textContent = progressTexts[currentStep];
                } else {
                    clearInterval(progressInterval);
                }
            }, 800);
        }

        // å‹•ç”»æº–å‚™
        function prepareVideo() {
            console.log('ğŸ“¹ Preparing video for fullscreen playback...');
            
            if (!fullscreenVideo || !originalVideo) {
                console.error('âŒ Video elements not found');
                hideLoadingOverlay();
                return;
            }
            
            // å…ƒå‹•ç”»ã®è¨­å®šã‚’å…¨ç”»é¢å‹•ç”»ã«ã‚³ãƒ”ãƒ¼
            fullscreenVideo.src = originalVideo.src;
            fullscreenVideo.currentTime = 0;
            fullscreenVideo.volume = 0.8;
            fullscreenVideo.muted = false;
            
            // å‹•ç”»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
            fullscreenVideo.addEventListener('loadeddata', function() {
                console.log('âœ… Video data loaded, starting playback...');
                startFullscreenVideo();
            }, { once: true });
            
            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            fullscreenVideo.addEventListener('error', function(e) {
                console.error('âŒ Video loading error:', e);
                hideLoadingOverlay();
                updateARStatus('âŒ å‹•ç”»èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', '#f44336');
            }, { once: true });
            
            // å‹•ç”»èª­ã¿è¾¼ã¿é–‹å§‹
            fullscreenVideo.load();
        }

        // å…¨ç”»é¢å‹•ç”»å†ç”Ÿé–‹å§‹
        function startFullscreenVideo() {
            setTimeout(() => {
                hideLoadingOverlay();
                
                // ARã‚·ãƒ¼ãƒ³ã‚’éš ã™
                document.querySelector('a-scene').style.display = 'none';
                document.getElementById('ar-status').style.display = 'none';
                
                // å…¨ç”»é¢å‹•ç”»è¡¨ç¤º
                fullscreenVideo.style.display = 'block';
                
                // å‹•ç”»å†ç”Ÿ
                fullscreenVideo.play().then(() => {
                    console.log('âœ… Fullscreen video playback started');
                    isVideoPlaying = true;
                    showVideoControls();
                }).catch(error => {
                    console.error('âŒ Video playback failed:', error);
                    // æ‰‹å‹•å†ç”Ÿãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                    showManualPlayButton();
                });
                
            }, 2000); // èª­ã¿è¾¼ã¿è¡¨ç¤ºã‚’2ç§’é–“ä¿æŒ
        }

        // èª­ã¿è¾¼ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤éè¡¨ç¤º
        function hideLoadingOverlay() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // å‹•ç”»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º
        function showVideoControls() {
            document.getElementById('video-controls').style.display = 'block';
            
            // 5ç§’å¾Œã«è‡ªå‹•ã§éš ã™
            setTimeout(() => {
                const controls = document.getElementById('video-controls');
                if (controls.style.display === 'block') {
                    controls.style.display = 'none';
                }
            }, 5000);
        }

        // æ‰‹å‹•å†ç”Ÿãƒœã‚¿ãƒ³ï¼ˆè‡ªå‹•å†ç”Ÿå¤±æ•—æ™‚ï¼‰
        function showManualPlayButton() {
            const playButton = document.createElement('div');
            playButton.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="margin: 0 0 20px 0; color: #00ffff;">ğŸ¬ å‹•ç”»ã‚’å†ç”Ÿ</h2>
                    <p style="margin: 0 0 20px 0; font-size: 16px;">ã‚¿ãƒƒãƒ—ã—ã¦å‹•ç”»ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
                    <button id="manual-play" style="padding: 20px 40px; background: #00ffff; color: #000; border: none; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer;">â–¶ å†ç”Ÿé–‹å§‹</button>
                </div>
            `;
            playButton.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 11000;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 40px;
                border-radius: 20px;
                text-align: center;
                font-family: Arial, sans-serif;
            `;
            
            document.body.appendChild(playButton);
            
            document.getElementById('manual-play').addEventListener('click', () => {
                fullscreenVideo.play().then(() => {
                    isVideoPlaying = true;
                    showVideoControls();
                    document.body.removeChild(playButton);
                });
            });
        }

        // å‹•ç”»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½
        function setupVideoControls() {
            // å†ç”Ÿ/ä¸€æ™‚åœæ­¢
            document.getElementById('play-pause-btn').addEventListener('click', () => {
                if (fullscreenVideo.paused) {
                    fullscreenVideo.play();
                    document.getElementById('play-pause-btn').textContent = 'â¸ ä¸€æ™‚åœæ­¢';
                } else {
                    fullscreenVideo.pause();
                    document.getElementById('play-pause-btn').textContent = 'â–¶ å†ç”Ÿ';
                }
            });
            
            // éŸ³é‡åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('volume-btn').addEventListener('click', () => {
                fullscreenVideo.muted = !fullscreenVideo.muted;
                document.getElementById('volume-btn').textContent = fullscreenVideo.muted ? 'ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ' : 'ğŸ”Š éŸ³é‡';
            });
            
            // ãƒ–ãƒ©ã‚¦ã‚¶å…¨ç”»é¢
            document.getElementById('fullscreen-btn').addEventListener('click', () => {
                if (fullscreenVideo.requestFullscreen) {
                    fullscreenVideo.requestFullscreen();
                } else if (fullscreenVideo.webkitRequestFullscreen) {
                    fullscreenVideo.webkitRequestFullscreen();
                }
            });
            
            // é–‰ã˜ã‚‹
            document.getElementById('close-btn').addEventListener('click', closeVideo);
            
            // å‹•ç”»ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º/éè¡¨ç¤º
            fullscreenVideo.addEventListener('click', () => {
                const controls = document.getElementById('video-controls');
                if (controls.style.display === 'none' || !controls.style.display) {
                    showVideoControls();
                } else {
                    controls.style.display = 'none';
                }
            });
        }

        // å‹•ç”»ã‚’é–‰ã˜ã‚‹
        function closeVideo() {
            fullscreenVideo.pause();
            fullscreenVideo.style.display = 'none';
            document.getElementById('video-controls').style.display = 'none';
            
            // ARã‚·ãƒ¼ãƒ³å¾©å¸°
            document.querySelector('a-scene').style.display = 'block';
            document.getElementById('ar-status').style.display = 'block';
            
            isVideoPlaying = false;
            videoTriggered = false;
            
            updateARStatus('ğŸ“± ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„', '#ffeb3b');
            console.log('ğŸ”„ Video closed, AR scene restored');
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ AR Fullscreen Video Player starting...');
            
            // å‹•ç”»è¦ç´ ã®å–å¾—
            fullscreenVideo = document.getElementById('fullscreen-video');
            originalVideo = document.getElementById('main-video');
            
            if (!fullscreenVideo || !originalVideo) {
                console.error('âŒ Video elements not found');
                return;
            }
            
            // å‹•ç”»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
            setupVideoControls();
            
            // å…ƒå‹•ç”»ã®èª­ã¿è¾¼ã¿ç¢ºèª
            originalVideo.addEventListener('loadeddata', () => {
                console.log('âœ… Original video loaded');
                updateARStatus('ğŸ“± ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„', '#ffeb3b');
            });
            
            originalVideo.addEventListener('error', (e) => {
                console.error('âŒ Original video error:', e);
                updateARStatus('âŒ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼', '#f44336');
            });
            
            // ESCã‚­ãƒ¼ã§å‹•ç”»ã‚’é–‰ã˜ã‚‹
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isVideoPlaying) {
                    closeVideo();
                }
            });
            
            console.log('âœ… AR Fullscreen Video Player initialized');
        });
    </script>
</body>
</html>