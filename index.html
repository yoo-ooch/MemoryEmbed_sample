<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Video Player - Improved Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- A-Frame ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <!-- AR.js ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body style='margin: 0; overflow: hidden; font-family: Arial, sans-serif;'>
    
    <!-- ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ  - æœ€é©åŒ–ã•ã‚ŒãŸè¨­å®š -->
    <a-scene 
        embedded 
        arjs='
            trackingMethod: best; 
            sourceType: webcam; 
            debugUIEnabled: true; 
            detectionMode: mono_and_matrix; 
            matrixCodeType: 3x3; 
            patternRatio: 0.90;
            maxDetectionRate: 60;
            canvasWidth: 640;
            canvasHeight: 480;
        '
        vr-mode-ui="enabled: false"
        loading-screen="enabled: false">
        
        <a-assets>
            <!-- å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
            <video 
                id="video1" 
                src="./assets/videos/sample-3.mp4" 
                preload="auto" 
                crossorigin="anonymous" 
                webkit-playsinline 
                playsinline 
                muted 
                loop
                width="640"
                height="480">
            </video>
        </a-assets>
        
        <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨ - æ¤œå‡ºæ„Ÿåº¦ã‚’ä¸Šã’ãŸè¨­å®š -->
        <a-marker 
            type="pattern" 
            url="./pattern-sample-p.patt" 
            id="custom-marker"
            raycaster="objects: .clickable"
            emitevents="true"
            cursor="fuse: false; rayOrigin: mouse;">
            
            <!-- ã‚ˆã‚Šç›®ç«‹ã¤ãƒ†ã‚¹ãƒˆç”¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
            <a-box 
                position="0 0.8 0" 
                color="#ff0000" 
                scale="0.3 0.3 0.3"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 2000">
            </a-box>
            
            <a-cylinder 
                position="0 0.4 0" 
                color="#00ff00" 
                radius="0.2" 
                height="0.1"
                animation="property: scale; to: 1.5 1 1.5; direction: alternate; loop: true; dur: 1000">
            </a-cylinder>
            
            <!-- å‹•ç”»ã‚’è¡¨ç¤ºã™ã‚‹å¹³é¢ -->
            <a-plane 
                position="0 0 0" 
                rotation="-90 0 0" 
                width="2" 
                height="1.5" 
                material="src: #video1; transparent: true; alphaTest: 0.1; side: double;">
            </a-plane>
            
            <!-- ã‚ˆã‚Šå¤§ããªã‚¿ã‚¤ãƒˆãƒ«ãƒ†ã‚­ã‚¹ãƒˆ -->
            <a-text 
                value="ğŸ¬ VIDEO PLAYING!" 
                position="0 1.5 0" 
                align="center" 
                color="#ffff00"
                scale="2 2 2">
            </a-text>
        </a-marker>
        
        <!-- ã‚«ãƒ¡ãƒ©ã‚’è¿½åŠ  -->
        <a-entity camera look-controls></a-entity>
    </a-scene>

    <!-- æ”¹è‰¯ã•ã‚ŒãŸãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div id="debug-panel" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.95); color: white; padding: 15px; border-radius: 8px; max-width: 320px; z-index: 1000; font-size: 11px;">
        <h3 style="margin: 0 0 12px 0; color: #00ff00; font-size: 14px;">ğŸ”§ Enhanced AR Debug</h3>
        
        <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œå‡ºçŠ¶æ…‹ -->
        <div style="margin: 8px 0; padding: 6px; background: rgba(255,255,255,0.1); border-radius: 4px;">
            <strong>ğŸ¯ Detection Status:</strong>
            <div id="detection-status" style="color: #ffeb3b; font-weight: bold;">å¾…æ©Ÿä¸­...</div>
            <div style="font-size: 10px;">
                æ¤œå‡º: <span id="found-count" style="color: #4caf50;">0</span> | 
                æ¶ˆå¤±: <span id="lost-count" style="color: #f44336;">0</span> |
                æ„Ÿåº¦: <span id="sensitivity" style="color: #2196f3;">é«˜</span>
            </div>
        </div>
        
        <!-- AR.jsè©³ç´°æƒ…å ± -->
        <div style="margin: 8px 0; padding: 6px; background: rgba(255,255,255,0.1); border-radius: 4px;">
            <strong>ğŸ“¡ AR Engine:</strong>
            <div id="ar-details" style="font-size: 10px; color: #4caf50;">åˆæœŸåŒ–ä¸­...</div>
        </div>
        
        <!-- ãƒãƒ¼ã‚«ãƒ¼æƒ…å ± -->
        <div style="margin: 8px 0; padding: 6px; background: rgba(255,255,255,0.1); border-radius: 4px;">
            <strong>ğŸ¯ Marker Info:</strong>
            <div style="font-size: 10px;">
                <div>Pattern: <span id="pattern-status" style="color: #4caf50;">âœ… èª­ã¿è¾¼ã¿æ¸ˆã¿</span></div>
                <div>ã‚µã‚¤ã‚º: <span style="color: #2196f3;">Pattern Ratio 0.90</span></div>
                <div>ç²¾åº¦: <span style="color: #ff9800;">æœ€å¤§æ¤œå‡ºãƒ¬ãƒ¼ãƒˆ 60fps</span></div>
            </div>
        </div>
        
        <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
        <div style="margin: 12px 0;">
            <button id="test-marker" style="padding: 6px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; margin: 2px;">ãƒãƒ¼ã‚«ãƒ¼ãƒ†ã‚¹ãƒˆ</button>
            <button id="test-video" style="padding: 6px 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; margin: 2px;">å‹•ç”»ãƒ†ã‚¹ãƒˆ</button>
            <button id="reset-ar" style="padding: 6px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; margin: 2px;">ARå†èµ·å‹•</button>
        </div>
        
        <!-- ãƒ’ãƒ³ãƒˆ -->
        <div style="margin: 8px 0; padding: 6px; background: rgba(33, 150, 243, 0.2); border-radius: 4px; border-left: 3px solid #2196f3;">
            <div style="font-size: 10px; color: #bbbbbb;">
                ğŸ’¡ <strong>æ¤œå‡ºã®ã‚³ãƒ„:</strong><br>
                â€¢ ãƒãƒ¼ã‚«ãƒ¼ã‹ã‚‰30-50cmé›¢ã™<br>
                â€¢ æ˜ã‚‹ã„å ´æ‰€ã§ä½¿ç”¨<br>
                â€¢ ãƒãƒ¼ã‚«ãƒ¼ã‚’å¹³ã‚‰ã«ç½®ã<br>
                â€¢ ã‚«ãƒ¡ãƒ©ã‚’å®‰å®šã•ã›ã‚‹
            </div>
        </div>
    </div>

    <script>
        let foundCount = 0;
        let lostCount = 0;
        let currentVideo = null;
        let isMarkerVisible = false;
        let arSystem = null;

        // çŠ¶æ…‹æ›´æ–°é–¢æ•°
        function updateDetectionStatus(status, color = '#ffeb3b') {
            const element = document.getElementById('detection-status');
            if (element) {
                element.textContent = status;
                element.style.color = color;
            }
            console.log(`Detection Status: ${status}`);
        }

        // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        AFRAME.registerComponent('enhanced-marker', {
            init: function () {
                const el = this.el;
                console.log('Enhanced marker component initialized');
                
                // ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸæ™‚
                el.addEventListener('markerFound', function() {
                    foundCount++;
                    isMarkerVisible = true;
                    
                    updateDetectionStatus(`ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºä¸­! (#${foundCount})`, '#4caf50');
                    document.getElementById('found-count').textContent = foundCount;
                    
                    console.log(`ğŸ¯ MARKER FOUND! Count: ${foundCount}`);
                    
                    // å‹•ç”»å†ç”Ÿï¼ˆæ”¹è‰¯ç‰ˆï¼‰
                    setTimeout(() => {
                        if (currentVideo && isMarkerVisible) {
                            currentVideo.muted = false; // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤
                            currentVideo.play().then(() => {
                                console.log('âœ… Video playing successfully');
                            }).catch(error => {
                                console.error('âŒ Video play failed:', error);
                            });
                        }
                    }, 200);
                });

                // ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹å¤±ã‚ã‚ŒãŸæ™‚
                el.addEventListener('markerLost', function() {
                    lostCount++;
                    isMarkerVisible = false;
                    
                    updateDetectionStatus(`âŒ ãƒãƒ¼ã‚«ãƒ¼æ¶ˆå¤± (#${lostCount})`, '#f44336');
                    document.getElementById('lost-count').textContent = lostCount;
                    
                    console.log(`âŒ MARKER LOST! Count: ${lostCount}`);
                    
                    // å‹•ç”»ä¸€æ™‚åœæ­¢ï¼ˆé…å»¶ã‚ã‚Šï¼‰
                    setTimeout(() => {
                        if (!isMarkerVisible && currentVideo) {
                            currentVideo.pause();
                            console.log('â¸ Video paused due to marker loss');
                        }
                    }, 1500);
                });
            }
        });

        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Enhanced AR Video Player starting...');
            
            // å‹•ç”»è¦ç´ ã®å–å¾—ã¨è¨­å®š
            currentVideo = document.querySelector('#video1');
            if (currentVideo) {
                currentVideo.addEventListener('loadeddata', () => {
                    console.log('âœ… Video data loaded');
                });
                
                currentVideo.addEventListener('canplay', () => {
                    console.log('âœ… Video ready to play');
                });
                
                currentVideo.addEventListener('error', (e) => {
                    console.error('âŒ Video error:', e);
                });
                
                // éŸ³é‡è¨­å®š
                currentVideo.volume = 0.8;
            }
            
            // AR.jsã‚·ã‚¹ãƒ†ãƒ ã®ç›£è¦–
            setTimeout(() => {
                const scene = document.querySelector('a-scene');
                if (scene && scene.systems) {
                    arSystem = scene.systems.arjs;
                    document.getElementById('ar-details').textContent = 'AR.js ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†';
                    console.log('AR.js system:', arSystem);
                }
            }, 2000);
            
            // ãƒãƒ¼ã‚«ãƒ¼ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ 
            setTimeout(() => {
                const marker = document.querySelector('#custom-marker');
                if (marker) {
                    marker.setAttribute('enhanced-marker', '');
                    console.log('âœ… Enhanced marker component attached');
                } else {
                    console.error('âŒ Marker element not found');
                }
            }, 3000);
            
            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
            setupButtons();
        });

        // ãƒœã‚¿ãƒ³æ©Ÿèƒ½ã®è¨­å®š
        function setupButtons() {
            // ãƒãƒ¼ã‚«ãƒ¼ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('test-marker').addEventListener('click', function() {
                const marker = document.querySelector('#custom-marker');
                if (marker) {
                    // ãƒãƒ¼ã‚«ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸€æ™‚çš„ã«è¡¨ç¤º
                    marker.object3D.visible = true;
                    updateDetectionStatus('ğŸ”§ ãƒãƒ¼ã‚«ãƒ¼å¼·åˆ¶è¡¨ç¤ºä¸­', '#ffeb3b');
                    
                    setTimeout(() => {
                        if (!isMarkerVisible) {
                            marker.object3D.visible = false;
                            updateDetectionStatus('ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...', '#ff9800');
                        }
                    }, 5000);
                }
            });

            // å‹•ç”»ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('test-video').addEventListener('click', function() {
                if (currentVideo) {
                    currentVideo.muted = false;
                    currentVideo.play().then(() => {
                        console.log('âœ… Manual video test successful');
                    }).catch(error => {
                        console.error('âŒ Manual video test failed:', error);
                    });
                }
            });

            // ARå†èµ·å‹•ãƒœã‚¿ãƒ³
            document.getElementById('reset-ar').addEventListener('click', function() {
                location.reload();
            });
        }

        // å®šæœŸçš„ãªã‚·ã‚¹ãƒ†ãƒ ç›£è¦–
        setInterval(() => {
            if (arSystem) {
                console.log('ğŸ“Š AR Status Check - Markers visible:', isMarkerVisible);
            }
        }, 5000);
    </script>
</body>
</html>